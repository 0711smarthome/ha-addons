# /nginx/ingress.conf

# Definiert ein benutzerdefiniertes Log-Format, um mehr Details zu sehen
log_format ingress_debug '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" REQ_URI:"$request_uri" URI:"$uri"';

server {
  listen 80;
  
  # Aktiviere unser neues Debug-Logging f端r alle Anfragen
  access_log /dev/stdout ingress_debug;

  allow 172.30.32.2;
  deny all;
  
  root /var/www;
  index index.html;

  # --- API ROUTING (端berarbeitete Version) ---
  # Der "^~" Modifier sorgt f端r einen priorisierten Prefix-Match.
  # Wenn eine URL mit "/api/scan" beginnt, wird dieser Block definitiv verwendet.
  # Das ist robuster als ein exakter Match mit "=".

  location ^~ /api/scan {
    proxy_pass http://1227.0.0.1:8888;
  }
  
  location ^~ /api/configure {
    proxy_pass http://127.0.0.1:8889;
  }
  
  location ^~ /api/progress {
    proxy_pass http://127.0.0.1:8890;
  }
  
  # Fallback f端r alle anderen Anfragen
  location / {
    try_files $uri $uri/ /index.html;
  }
}