<!DOCTYPE html>
<html lang="de" data-bs-theme="light">
<head>
    <meta charset="UTF-arUTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelly WLAN Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/flatly/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .card-header { background-color: #662880 !important; }
        pre { white-space: pre-wrap; word-break: break-all; }
        .signal-good { color: var(--bs-success); }
        .signal-medium { color: var(--bs-warning); }
        .signal-poor { color: var(--bs-danger); }
        /* Admin Icon: weiß, bei Hover #d60b52 */
        #settingsIcon svg path { fill: white; transition: fill 0.2s ease-in-out; }
        #settingsIcon:hover svg path { fill: #d60b52; }
        #adminLogin.d-none { display: none !important; }
    </style>
</head>
<body class="bg-light">

    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <div class="container my-4">

        <div id="userModeContainer">
            <div class="card shadow-sm position-relative">
                <div class="position-absolute top-0 end-0 p-2" id="settingsIcon" onclick="showAdminLogin()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="32" height="32" style="cursor: pointer;"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M320 96C284.7 96 256 124.7 256 160L256 224L448 224C483.3 224 512 252.7 512 288L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 288C128 252.7 156.7 224 192 224L192 160C192 89.3 249.3 32 320 32C383.5 32 436.1 78.1 446.2 138.7C449.1 156.1 437.4 172.6 419.9 175.6C402.4 178.6 386 166.8 383 149.3C378 119.1 351.7 96 320 96zM360 424C373.3 424 384 413.3 384 400C384 386.7 373.3 376 360 376L280 376C266.7 376 256 386.7 256 400C256 413.3 266.7 424 280 424L360 424z"/></svg>
                </div>
                <div class="card-header text-white d-flex align-items-center">
                    <img src="logo_1.png" alt="Logo" style="height: 40px;" class="me-3">
                    <h1 class="h3 mb-0 flex-grow-1 text-center">Shelly Konfiguration</h1>
                </div>
                <div class="card-body">
                    <div id="userPinStep">
                        <p class="mb-2">Bitte gib die PIN ein, um die vorbereitete Geräteliste zu laden.</p>
                        <div class="input-group">
                            <input type="password" id="pinInput" class="form-control" placeholder="PIN" inputmode="numeric">
                            <button id="loadUserListBtn" onclick="loadDeviceListForUser()" class="btn btn-primary">Laden</button>
                        </div>
                    </div>
                    <div id="userMainStep" class="d-none">
                        <div class="row g-4">
                            <div class="col-lg-5">
                                <h2 class="h5">1. Zugangsdaten & Aktionen</h2>
                                <div class="mb-3">
                                    <label for="userSsid" class="form-label">WLAN-Name (SSID)</label>
                                    <input type="text" id="userSsid" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="userPassword" class="form-label">WLAN-Passwort</label>
                                    <input type="password" id="userPassword" class="form-control">
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="scanUserBtn" onclick="scanForUserDevices()" class="btn btn-info">
                                        <span class="spinner-border spinner-border-sm me-2 d-none" id="scanUserBtnSpinner"></span>
                                        Geräte suchen & auflisten
                                    </button>
                                    <button id="configureBtn" onclick="startUserConfiguration()" class="btn btn-primary" disabled>
                                        Ausgewählte Geräte konfigurieren
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-7">
                                <div id="userDeviceListContainer" class="d-none">
                                    <h2 class="h5">2. Geräteliste</h2>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="userShellyTable">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>Gerät</th>
                                                    <th>Status / Signal</th>
                                                    <th>Zuletzt Konfiguriert</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <div id="notFoundDevices" class="mt-4 d-none">
                                        <div class="alert alert-warning">
                                            <h4 class="alert-heading">Nicht gefundene Geräte</h4>
                                            <ul id="notFoundList" class="mb-0"></ul>
                                            <hr>
                                            <p class="mb-0 small">Stellen Sie sicher, dass diese Geräte eingeschaltet und in Reichweite des RasPi sind.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h3 class="h6">Protokoll</h3>
                            <pre id="userDebugLog" class="form-control bg-dark text-white" style="height: 150px; font-size: 0.8em;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="adminLogin" class="d-none">
            <div class="card shadow-sm mx-auto" style="max-width: 400px;">
                <div class="card-header text-white"><h1 class="h3 mb-0 flex-grow-1 text-center">Admin-Login</h1></div>
                <div class="card-body">
                    <p>Bitte gib das Admin-Passwort ein.</p>
                    <input type="password" id="adminPasswordInput" class="form-control mb-2">
                    <div class="d-grid gap-2">
                        <button onclick="checkAdminPassword()" class="btn btn-primary">Einloggen</button>
                        <button class="btn btn-secondary" onclick="showUserMode()">Zurück</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="adminPanel" class="d-none">
            <div class="card shadow-sm">
                <div class="card-header text-white"><h1 class="h3 mb-0 flex-grow-1 text-center">Geräte-Verwaltung</h1></div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3 align-items-center border-bottom pb-3">
                        <button id="adminScanBtn" onclick="scanForNewDevices()" class="btn btn-info">
                            <span class="spinner-border spinner-border-sm me-2 d-none" id="adminScanBtnSpinner"></span>
                            Nach neuen Geräten suchen
                        </button>
                        <button onclick="saveChangesToServer()" class="btn btn-success">Änderungen speichern</button>
                        <div class="input-group ms-md-auto" style="max-width: 250px;">
                            <input type="password" id="adminPinInput" class="form-control" placeholder="PIN für Liste">
                            <button class="btn btn-primary" onclick="loadAndDisplayDevicesForAdmin()">Laden</button>
                        </div>
                        <button class="btn btn-secondary" onclick="showUserMode()">Benutzermodus</button>
                    </div>
                    <div class="table-responsive">
                        <table id="deviceListTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Modell / SSID</th>
                                    <th>Gen</th>
                                    <th>Bemerkung</th>
                                    <th>Name (HA)</th>
                                    <th>Zuletzt Konfiguriert</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <h3 class="h6">Debug-Protokoll</h3>
                        <pre id="adminDebugLog" class="form-control bg-dark text-white" style="height: 200px; font-size: 0.8em;"></pre>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js?v=0.6.1"></script>
</body>
</html>