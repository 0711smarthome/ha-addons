<!DOCTYPE html>
<html lang="de" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelly WLAN Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/flatly/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .card-header { background-color: #662880 !important; }
        pre { white-space: pre-wrap; word-break: break-all; }
        .signal-good { color: var(--bs-success); }
        .signal-medium { color: var(--bs-warning); }
        .signal-poor { color: var(--bs-danger); }
        #settingsIcon svg path { fill: var(--bs-gray-600); }
        #settingsIcon:hover svg path { fill: var(--bs-light); } /* Hover color is now white */
        #adminLogin.d-none { display: none !important; }
        .header-content { display: flex; align-items: center; } /* Für Logo und Titel */
        .header-content img { margin-right: 10px; } /* Abstand zwischen Logo und Titel */
    </style>
</head>
<body class="bg-light">

    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <div class="container my-4">

        <div id="userModeContainer">
            <div class="card shadow-sm position-relative">
                <div class="position-absolute top-0 end-0 p-2" id="settingsIcon" onclick="showAdminLogin()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" style="cursor: pointer;">
                      <path d="m8,12c-3.309,0-6-2.691-6-6S4.691,0,8,0s6,2.691,6,6-2.691,6-6,6Zm14.5,6c0-.46-.089-.895-.218-1.313l1.416-.816-.998-1.733-1.411.813c-.605-.652-1.393-1.125-2.289-1.33v-1.621h-2v1.621c-.896.205-1.685-.678-2.289,1.33l-1.411-.813-.998,1.733,1.416.816c-.129.418-.218.853-.218,1.313s.089.895.218,1.313l-1.416.816.998,1.733,1.411-.813c.605.652,1.393,1.125,2.289,1.33v1.621h2v-1.621c.896-.205,1.685-.678,2.289,1.33l1.411.813.998-1.733-1.416-.816c.129-.418.218-.853-.218,1.313Zm-4.5,1.5c-.827,0-1.5-.673-1.5-1.5s.673-1.5,1.5-1.5,1.5.673,1.5,1.5-.673,1.5-1.5,1.5Zm-8-1.5c0-1.459.397-2.822,1.079-4h-6.579c-2.481,0-4.5,2.019-4.5,4.5v5.5h12.721c-1.665-1.466-2.721-3.607-2.721-6Z"/>
                    </svg>
                </div>
                <div class="card-header text-white">
                    <div class="header-content">
                        <img src="logo_w.png" alt="Logo" style="height: 40px;">
                        <h1 class="h3 mb-0">Shelly Konfiguration</h1>
                    </div>
                </div>
                <div class="card-body">
                    <div id="userPinStep">
                        <p class="mb-2">Bitte gib die PIN ein, um die vorbereitete Geräteliste zu laden.</p>
                        <div class="input-group">
                            <input type="password" id="pinInput" class="form-control" placeholder="PIN" inputmode="numeric">
                            <button id="loadUserListBtn" onclick="loadDeviceListForUser()" class="btn btn-primary">Laden</button>
                        </div>
                    </div>
                    <div id="userMainStep" class="d-none">
                        <div class="row g-4">
                            <div class="col-md-5">
                                <h2 class="h5">1. Zugangsdaten & Aktionen</h2>
                                <div class="mb-3">
                                    <label for="userSsid" class="form-label">WLAN-Name (SSID)</label>
                                    <input type="text" id="userSsid" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="userPassword" class="form-label">WLAN-Passwort</label>
                                    <input type="password" id="userPassword" class="form-control">
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="scanUserBtn" onclick="scanForUserDevices()" class="btn btn-info">
                                        <span class="spinner-border spinner-border-sm me-2 d-none" id="scanUserBtnSpinner"></span>
                                        Geräte suchen & auflisten
                                    </button>
                                    <button id="configureBtn" onclick="startUserConfiguration()" class="btn btn-primary" disabled>
                                        Ausgewählte Geräte konfigurieren
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div id="userDeviceListContainer" class="d-none">
                                    <h2 class="h5">2. Geräteliste</h2>
                                    <div id="userShellyList" class="list-group"></div>
                                    <div id="notFoundDevices" class="mt-4 d-none">
                                        <div class="alert alert-warning">
                                            <h4 class="alert-heading">Nicht gefundene Geräte</h4>
                                            <ul id="notFoundList" class="mb-0"></ul>
                                            <hr><p class="mb-0 small">Stellen Sie sicher, dass diese Geräte eingeschaltet sind.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h3 class="h6">Protokoll</h3>
                            <pre id="userDebugLog" class="form-control bg-dark text-white" style="height: 150px; font-size: 0.8em;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="adminLogin" class="d-none">
            <div class="card shadow-sm mx-auto" style="max-width: 400px;">
                <div class="card-header text-white"><h1 class="h3 mb-0">Admin-Login</h1></div>
                <div class="card-body">
                    <p>Bitte gib das Admin-Passwort ein.</p>
                    <input type="password" id="adminPasswordInput" class="form-control mb-2">
                    <div class="d-grid gap-2">
                        <button onclick="checkAdminPassword()" class="btn btn-primary">Einloggen</button>
                        <button class="btn btn-secondary" onclick="showUserMode()">Zurück</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="adminPanel" class="d-none">
            <div class="card shadow-sm">
                <div class="card-header text-white"><h1 class="h3 mb-0">Geräte-Verwaltung</h1></div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3 align-items-center border-bottom pb-3">
                        <button id="adminScanBtn" onclick="scanForNewDevices()" class="btn btn-info">
                            <span class="spinner-border spinner-border-sm me-2 d-none" id="adminScanBtnSpinner"></span>
                            Nach neuen Geräten suchen
                        </button>
                        <button onclick="saveChangesToServer()" class="btn btn-success">Änderungen speichern</button>
                        <div class="input-group ms-md-auto" style="max-width: 250px;">
                            <input type="password" id="adminPinInput" class="form-control" placeholder="PIN für Liste">
                            <button class="btn btn-primary" onclick="loadAndDisplayDevicesForAdmin()">Laden</button>
                        </div>
                        <button class="btn btn-secondary" onclick="showUserMode()">Benutzermodus</button>
                    </div>
                    <div class="table-responsive">
                        <table id="deviceListTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Modell / SSID</th>
                                    <th>Gen</th>
                                    <th>Bemerkung</th>
                                    <th>Name (HA)</th>
                                    <th>Zuletzt Konfiguriert</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <h3 class="h6">Debug-Protokoll</h3>
                        <pre id="adminDebugLog" class="form-control bg-dark text-white" style="height: 200px; font-size: 0.8em;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js?v=0.5.3"></script>
</body>
</html>